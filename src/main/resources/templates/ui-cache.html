<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–µ—à–∞–º–∏ - Football UA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/cache.css" rel="stylesheet">
</head>

<body>

    <header class="site-header">
        <div class="top-bar">
            <div class="wrap">
                <div class="top-bar-content">
                    <div class="site-logo">
                        <span class="logo-icon">‚öΩ</span>
                        <span class="logo-text">FOOTBALL HUB</span>
                    </div>
                    <nav class="main-nav">
                        <a href="/index.html" class="nav-link">–ì–æ–ª–æ–≤–Ω–∞ SPA</a>
                        <a th:href="@{/ui/home}" class="nav-link">UI –¥–µ–º–æ</a>
                        <a th:href="@{/ui/feedback}" class="nav-link">–í—ñ–¥–≥—É–∫</a>
                        <a th:href="@{/ui/roles}" class="nav-link">–†–æ–ª—ñ</a>
                        <a th:href="@{/ui/cache}" class="nav-link active">–ö–µ—à</a>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <main class="site-main">
        <div class="wrap">
            <div class="content-layout">
                <div class="main-content">
                    <section class="panel active">
                        <div class="section-title">
                            <h2>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–µ—à–∞–º–∏ —Å–∏—Å—Ç–µ–º–∏</h2>
                            <p>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—ñ–≤ –¥–æ–¥–∞—Ç–∫—É</p>
                        </div>

                        <!-- Loading Overlay -->
                        <div id="loadingOverlay" class="loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>

                        <!-- Alert Messages -->
                        <div id="alertSuccess" class="alert alert-success">
                            <span id="alertSuccessText"></span>
                        </div>
                        <div id="alertError" class="alert alert-error">
                            <span id="alertErrorText"></span>
                        </div>

                        <!-- Stats Overview -->
                        <div id="statsOverview" class="cache-section">
                            <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        </div>

                        <!-- Data Management Section -->
                        <div class="cache-section" sec:authorize="hasRole('MODERATOR')">
                            <div class="section-title">
                                <h3>üéõÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∞–Ω–∏–º–∏</h3>
                                <p>–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ API —Ç–∞ –∑–∞–ø—É—Å–∫ batch-–∑–∞–≤–¥–∞–Ω—å</p>
                            </div>

                            <!-- Action Cards Grid -->
                            <div class="action-grid">
                                <!-- Teams Card -->
                                <div class="action-card">
                                    <div class="action-icon">‚öΩ</div>
                                    <h4 class="action-title">–ö–æ–º–∞–Ω–¥–∏</h4>
                                    <p class="action-desc">–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ–º–∞–Ω–¥</p>
                                    <button id="btnRefreshTeamsFromApi" class="btn-action btn-action-success">
                                        –û–Ω–æ–≤–∏—Ç–∏
                                    </button>
                                </div>

                                <!-- Matches Card -->
                                <div class="action-card">
                                    <div class="action-icon">üìÖ</div>
                                    <h4 class="action-title">–ú–∞—Ç—á—ñ</h4>
                                    <p class="action-desc">–û–Ω–æ–≤–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ –º–∞—Ç—á—ñ–≤</p>
                                    <button id="btnRefreshMatchesFromApi" class="btn-action btn-action-success">
                                        –û–Ω–æ–≤–∏—Ç–∏
                                    </button>
                                </div>

                                <!-- Standings Card -->
                                <div class="action-card">
                                    <div class="action-icon">üìä</div>
                                    <h4 class="action-title">–¢–∞–±–ª–∏—Ü—ñ</h4>
                                    <p class="action-desc">–û–Ω–æ–≤–∏—Ç–∏ —Ç—É—Ä–Ω—ñ—Ä–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ</p>
                                    <button id="btnRefreshStandingsFromApi" class="btn-action btn-action-success">
                                        –û–Ω–æ–≤–∏—Ç–∏
                                    </button>
                                </div>

                                <!-- Scorers Card -->
                                <div class="action-card">
                                    <div class="action-icon">ü•á</div>
                                    <h4 class="action-title">–ë–æ–º–±–∞—Ä–¥–∏—Ä–∏</h4>
                                    <p class="action-desc">–û–Ω–æ–≤–∏—Ç–∏ —Ç–æ–ø-–±–æ–º–±–∞—Ä–¥–∏—Ä—ñ–≤</p>
                                    <button id="btnRefreshScorersFromApi" class="btn-action btn-action-success">
                                        –û–Ω–æ–≤–∏—Ç–∏
                                    </button>
                                </div>

                                <!-- Refresh All Card -->
                                <div class="action-card action-card-highlight">
                                    <div class="action-icon">üîÑ</div>
                                    <h4 class="action-title">–û–Ω–æ–≤–∏—Ç–∏ –≤—Å–µ</h4>
                                    <p class="action-desc">–ü–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö</p>
                                    <button id="btnRefreshAllFromApi" class="btn-action btn-action-primary">
                                        –û–Ω–æ–≤–∏—Ç–∏ –≤—Å–µ
                                    </button>
                                </div>

                                <!-- Batch Job Card -->
                                <div class="action-card action-card-special">
                                    <div class="action-icon">‚öôÔ∏è</div>
                                    <h4 class="action-title">Batch Job</h4>
                                    <p class="action-desc">–ú—ñ–≥—Ä–∞—Ü—ñ—è –∫–µ—à ‚Üí –ë–î</p>
                                    <button id="btnRunBatchJob" class="btn-action btn-action-warning">
                                        –ó–∞–ø—É—Å—Ç–∏—Ç–∏
                                    </button>
                                </div>
                            </div>

                            <!-- Status Display Area -->
                            <div id="actionStatusArea" class="action-status-area">
                                <div class="status-indicator"></div>
                                <span id="actionStatusText" class="status-text">–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏</span>
                            </div>
                        </div>

                        <!-- Toolbar -->
                        <div class="cache-toolbar">
                            <h3 class="toolbar-title">–°–ø–∏—Å–æ–∫ –∫–µ—à—ñ–≤</h3>
                            <div class="toolbar-actions">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="showEmptyCaches">
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ</span>
                                </label>
                                <button id="btnRefreshAllStats" class="btn btn-primary">
                                    üîÑ –û–Ω–æ–≤–∏—Ç–∏
                                </button>
                                <button id="btnClearAllCaches" class="btn btn-danger">
                                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ
                                </button>
                            </div>
                        </div>

                        <!-- Cache Table -->
                        <div class="cache-table-container">
                            <table class="cache-table">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∑–≤–∞ –∫–µ—à—É</th>
                                        <th>–ó–∞–ø–∏—Ç—ñ–≤</th>
                                        <th>–í–ª—É—á–µ–Ω—å</th>
                                        <th>–ü—Ä–æ–º–∞—Ö—ñ–≤</th>
                                        <th>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                                        <th>–†–æ–∑–º—ñ—Ä</th>
                                        <th>–î—ñ—ó</th>
                                    </tr>
                                </thead>
                                <tbody id="cacheTableBody">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                            <div id="emptyTableState" class="empty-state" style="display: none;">
                                <div class="empty-icon">üì¶</div>
                                <h3 class="empty-title">–ê–∫—Ç–∏–≤–Ω–∏—Ö –∫–µ—à—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
                                <p class="empty-description">–£–≤—ñ–º–∫–Ω—ñ—Ç—å "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ", —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å—ñ –∫–µ—à—ñ.</p>
                            </div>
                        </div>

                    </section>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API –±–∞–∑–æ–≤–∏–π URL
        const API_BASE = '/api/cache';

        // DOM –µ–ª–µ–º–µ–Ω—Ç–∏
        const alertSuccess = document.getElementById('alertSuccess');
        const alertError = document.getElementById('alertError');
        const alertSuccessText = document.getElementById('alertSuccessText');
        const alertErrorText = document.getElementById('alertErrorText');
        const cacheTableBody = document.getElementById('cacheTableBody');
        const emptyTableState = document.getElementById('emptyTableState');
        const statsOverview = document.getElementById('statsOverview');
        const btnRefreshAllStats = document.getElementById('btnRefreshAllStats');
        const btnClearAllCaches = document.getElementById('btnClearAllCaches');
        const btnRefreshTeamsFromApi = document.getElementById('btnRefreshTeamsFromApi');
        const btnRefreshMatchesFromApi = document.getElementById('btnRefreshMatchesFromApi');
        const btnRefreshStandingsFromApi = document.getElementById('btnRefreshStandingsFromApi');
        const btnRefreshScorersFromApi = document.getElementById('btnRefreshScorersFromApi');
        const btnRefreshAllFromApi = document.getElementById('btnRefreshAllFromApi');
        const btnRunBatchJob = document.getElementById('btnRunBatchJob');
        const actionStatusArea = document.getElementById('actionStatusArea');
        const actionStatusText = document.getElementById('actionStatusText');
        const showEmptyCachesCheckbox = document.getElementById('showEmptyCaches');

        // Global state for stats
        let currentStats = {};
        let currentCacheNames = [];

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function () {
            loadAllCacheStats();
        });

        // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–∏–π loading overlay
        function showGlobalLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // –î–æ–¥–∞—Ç–∏ –∫–ª–∞—Å loading –¥–æ –∫–Ω–æ–ø–æ–∫
        function setButtonLoading(button, loading = true) {
            if (!button) return;

            if (loading) {
                button.disabled = true;
                const originalText = button.innerText;
                button.dataset.originalText = originalText;
                button.innerHTML = '‚è≥...';
            } else {
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.innerText = button.dataset.originalText;
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function showAlert(message, type = 'success') {
            if (!alertSuccess || !alertError) return;

            const alert = type === 'success' ? alertSuccess : alertError;
            const alertText = type === 'success' ? alertSuccessText : alertErrorText;

            alertSuccess.style.display = 'none';
            alertError.style.display = 'none';

            alertText.textContent = message;
            alert.style.display = 'flex';

            setTimeout(() => {
                if (alert) alert.style.display = 'none';
            }, 5000);
        }

        // –í–∏–∫–ª–∏–∫ API
        async function callApi(endpoint, method = 'GET', body = null) {
            const config = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin'
            };

            if (body) config.body = JSON.stringify(body);

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                if (!response.ok) throw new Error(`HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å—ñ—Ö –∫–µ—à—ñ–≤
        async function loadAllCacheStats() {
            try {
                setButtonLoading(btnRefreshAllStats, true);

                const [infoData, statsData] = await Promise.all([
                    callApi('/info'),
                    callApi('/stats')
                ]);

                currentCacheNames = infoData.cacheNames;
                currentStats = statsData;

                renderCacheTable();
                renderOverviewStats(statsData);

                showAlert('üìä –î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');

            } catch (error) {
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshAllStats, false);
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        function renderOverviewStats(stats) {
            if (!statsOverview) return;

            if (Object.keys(stats).length === 0) {
                statsOverview.innerHTML = '';
                return;
            }

            let totalRequests = 0;
            let totalHits = 0;
            let totalSize = 0;
            let activeCaches = 0;

            for (const cacheStats of Object.values(stats)) {
                const requests = cacheStats.hitCount + cacheStats.missCount;
                totalRequests += requests;
                totalHits += cacheStats.hitCount;
                totalSize += cacheStats.size;
                if (requests > 0) activeCaches++;
            }

            const hitRate = totalRequests > 0 ? (totalHits / totalRequests) * 100 : 0;

            statsOverview.innerHTML = `
        <div class="cache-card">
            <div class="cache-stats">
                <div class="stat-item">
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –∫–µ—à—ñ–≤</div>
                    <div class="stat-value">${activeCaches} / ${Object.keys(stats).length}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Ç—ñ–≤</div>
                    <div class="stat-value" style="color: var(--primary);">${totalRequests.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</div>
                    <div class="stat-value" style="color: var(--secondary);">${hitRate.toFixed(1)}%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä</div>
                    <div class="stat-value">${totalSize.toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
        }

        // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –∫–µ—à—ñ–≤
        function renderCacheTable() {
            if (!cacheTableBody) return;

            cacheTableBody.innerHTML = '';

            const showEmpty = showEmptyCachesCheckbox ? showEmptyCachesCheckbox.checked : false;
            let visibleCount = 0;

            currentCacheNames.sort().forEach(cacheName => {
                const cacheStats = currentStats[cacheName] || {
                    hitCount: 0,
                    missCount: 0,
                    size: 0,
                    hitRate: 0
                };

                const totalRequests = cacheStats.hitCount + cacheStats.missCount;

                // Filter logic: Hide if no requests AND showEmpty is false
                if (totalRequests === 0 && !showEmpty) {
                    return;
                }

                visibleCount++;
                const hitRate = cacheStats.hitRate * 100;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="cache-name-cell">
                <span class="cache-icon">üì¶</span>
                <span class="name-text">${cacheName}</span>
            </td>
            <td>${totalRequests.toLocaleString()}</td>
            <td class="text-success">${cacheStats.hitCount.toLocaleString()}</td>
            <td class="text-danger">${cacheStats.missCount.toLocaleString()}</td>
            <td>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${hitRate}%"></div>
                    <span class="progress-text">${hitRate.toFixed(1)}%</span>
                </div>
            </td>
            <td>${cacheStats.size.toLocaleString()}</td>
            <td>
                <div class="row-actions">
                    <button class="btn-icon btn-clear" onclick="clearCache('${cacheName}')" title="–û—á–∏—Å—Ç–∏—Ç–∏">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        `;
                cacheTableBody.appendChild(row);
            });

            if (visibleCount === 0) {
                cacheTableBody.parentElement.style.display = 'none';
                emptyTableState.style.display = 'flex';
            } else {
                cacheTableBody.parentElement.style.display = 'table';
                emptyTableState.style.display = 'none';
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∫–µ—à—ñ
        async function clearAllCaches() {
            if (!confirm('‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç–∏ –í–°–Ü –∫–µ—à—ñ?')) return;

            try {
                showGlobalLoading(true);
                await callApi('/clear', 'DELETE');
                showAlert('‚úÖ –í—Å—ñ –∫–µ—à—ñ –æ—á–∏—â–µ–Ω–æ', 'success');
                loadAllCacheStats();
            } catch (error) {
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            } finally {
                showGlobalLoading(false);
            }
        }

        // –û—á–∏—Å—Ç–∏—Ç–∏ –æ–∫—Ä–µ–º–∏–π –∫–µ—à
        async function clearCache(cacheName) {
            if (!confirm(`üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à "${cacheName}"?`)) return;

            try {
                showGlobalLoading(true);
                const result = await callApi(`/clear/${cacheName}`, 'DELETE');
                showAlert(`‚úÖ –ö–µ—à "${cacheName}" –æ—á–∏—â–µ–Ω–æ (${result.clearedElements} –µ–ª.)`, 'success');
                loadAllCacheStats();
            } catch (error) {
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            } finally {
                showGlobalLoading(false);
            }
        }

        // –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –∑ API
        async function refreshTeamsFromApi() {
            try {
                setButtonLoading(btnRefreshTeamsFromApi, true);
                showActionStatus('‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥ –∑ API...', 'loading');

                const response = await fetch('/api/moderator/teams/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showActionStatus(`‚úÖ –ö–æ–º–∞–Ω–¥–∏: ${result.message}`, 'success');
                    showAlert(`üöÄ ${result.message}`, 'success');
                } else {
                    showActionStatus(`‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∏: ${result.message}`, 'error');
                    showAlert(`‚ö†Ô∏è ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Teams API Error:', error);
                showActionStatus(`‚ùå –ö–æ–º–∞–Ω–¥–∏: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshTeamsFromApi, false);
            }
        }


        // –û–Ω–æ–≤–∏—Ç–∏ –º–∞—Ç—á—ñ –∑ API
        async function refreshMatchesFromApi() {
            try {
                setButtonLoading(btnRefreshMatchesFromApi, true);
                showActionStatus('‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤ –∑ API...', 'loading');

                const response = await fetch('/api/moderator/matches/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    let detailsText = '';
                    if (result.details) {
                        detailsText = Object.entries(result.details)
                            .map(([league, count]) => `${league}: ${count}`)
                            .join(', ');
                    }
                    showActionStatus(`‚úÖ –ú–∞—Ç—á—ñ: ${result.message}${detailsText ? ` (${detailsText})` : ''}`, 'success');
                    showAlert(`üöÄ ${result.message}`, 'success');
                } else {
                    showActionStatus(`‚ö†Ô∏è –ú–∞—Ç—á—ñ: ${result.message}`, 'error');
                    showAlert(`‚ö†Ô∏è ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Matches API Error:', error);
                showActionStatus(`‚ùå –ú–∞—Ç—á—ñ: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshMatchesFromApi, false);
            }
        }

        // –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ –∑ API
        async function refreshStandingsFromApi() {
            try {
                setButtonLoading(btnRefreshStandingsFromApi, true);
                showActionStatus('‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –∑ API...', 'loading');

                const response = await fetch('/api/moderator/standings/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showActionStatus(`‚úÖ –¢–∞–±–ª–∏—Ü—ñ: ${result.message}`, 'success');
                    showAlert(`üöÄ ${result.message}`, 'success');
                } else {
                    showActionStatus(`‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—ñ: ${result.message}`, 'error');
                    showAlert(`‚ö†Ô∏è ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Standings API Error:', error);
                showActionStatus(`‚ùå –¢–∞–±–ª–∏—Ü—ñ: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshStandingsFromApi, false);
            }
        }

        // –û–Ω–æ–≤–∏—Ç–∏ –±–æ–º–±–∞—Ä–¥–∏—Ä—ñ–≤ –∑ API
        async function refreshScorersFromApi() {
            try {
                setButtonLoading(btnRefreshScorersFromApi, true);
                showActionStatus('‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–æ–º–±–∞—Ä–¥–∏—Ä—ñ–≤ –∑ API...', 'loading');

                const response = await fetch('/api/moderator/scorers/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showActionStatus(`‚úÖ –ë–æ–º–±–∞—Ä–¥–∏—Ä–∏: ${result.message}`, 'success');
                    showAlert(`üöÄ ${result.message}`, 'success');
                } else {
                    showActionStatus(`‚ö†Ô∏è –ë–æ–º–±–∞—Ä–¥–∏—Ä–∏: ${result.message}`, 'error');
                    showAlert(`‚ö†Ô∏è ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('Scorers API Error:', error);
                showActionStatus(`‚ùå –ë–æ–º–±–∞—Ä–¥–∏—Ä–∏: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–æ–º–±–∞—Ä–¥–∏—Ä—ñ–≤: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshScorersFromApi, false);
            }
        }

        // –û–Ω–æ–≤–∏—Ç–∏ –í–°–ï –∑ API
        async function refreshAllFromApi() {
            try {
                setButtonLoading(btnRefreshAllFromApi, true);
                showActionStatus('‚è≥ –ü–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –í–°–Ü–• –¥–∞–Ω–∏—Ö... –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ 1-2 —Ö–≤–∏–ª–∏–Ω–∏...', 'loading');

                const response = await fetch('/api/moderator/all/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                    throw new Error(errorData.message || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showActionStatus(`‚úÖ –í—Å–µ –æ–Ω–æ–≤–ª–µ–Ω–æ: ${result.message}`, 'success');
                    showAlert(`üöÄ ${result.message}`, 'success');
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à—ñ–≤
                    loadAllCacheStats();
                } else {
                    showActionStatus(`‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è: ${result.message}`, 'error');
                    showAlert(`‚ö†Ô∏è ${result.message}`, 'error');
                }

            } catch (error) {
                console.error('All Refresh API Error:', error);
                showActionStatus(`‚ùå –ü–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRefreshAllFromApi, false);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥—ñ—ó
        function showActionStatus(message, type = 'info') {
            if (!actionStatusArea || !actionStatusText) return;

            actionStatusText.textContent = message;

            // –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–ª–∞—Å–∏ —Å—Ç–∞—Ç—É—Å—É
            actionStatusArea.classList.remove('status-loading', 'status-success', 'status-error');

            // –î–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –∫–ª–∞—Å
            if (type === 'loading' || type === 'info') {
                actionStatusArea.classList.add('status-loading');
            } else if (type === 'success') {
                actionStatusArea.classList.add('status-success');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–æ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    actionStatusArea.classList.remove('status-success');
                    actionStatusText.textContent = '–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏';
                }, 10000);
            } else if (type === 'error') {
                actionStatusArea.classList.add('status-error');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–æ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    actionStatusArea.classList.remove('status-error');
                    actionStatusText.textContent = '–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏';
                }, 15000);
            }
        }

        // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ Spring Batch Job
        async function runBatchJob() {
            try {
                setButtonLoading(btnRunBatchJob, true);
                showActionStatus('‚è≥ –ó–∞–ø—É—Å–∫ Spring Batch Job (cacheToDatabaseJob)...', 'loading');

                const response = await fetch('/api/batch/cache-to-db/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.text().catch(() => `HTTP ${response.status}`);
                    throw new Error(errorData || `HTTP –ø–æ–º–∏–ª–∫–∞ ${response.status}`);
                }

                const result = await response.text();
                showActionStatus(`‚úÖ Batch Job: ${result}`, 'success');
                showAlert(`‚öôÔ∏è ${result}`, 'success');

            } catch (error) {
                console.error('Batch Job Error:', error);
                showActionStatus(`‚ùå Batch Job: ${error.message}`, 'error');
                showAlert(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É Batch Job: ${error.message}`, 'error');
            } finally {
                setButtonLoading(btnRunBatchJob, false);
            }
        }


        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        if (btnRefreshAllStats) btnRefreshAllStats.addEventListener('click', loadAllCacheStats);
        if (btnClearAllCaches) btnClearAllCaches.addEventListener('click', clearAllCaches);
        if (btnRefreshTeamsFromApi) btnRefreshTeamsFromApi.addEventListener('click', refreshTeamsFromApi);
        if (btnRefreshMatchesFromApi) btnRefreshMatchesFromApi.addEventListener('click', refreshMatchesFromApi);
        if (btnRefreshStandingsFromApi) btnRefreshStandingsFromApi.addEventListener('click', refreshStandingsFromApi);
        if (btnRefreshScorersFromApi) btnRefreshScorersFromApi.addEventListener('click', refreshScorersFromApi);
        if (btnRefreshAllFromApi) btnRefreshAllFromApi.addEventListener('click', refreshAllFromApi);
        if (btnRunBatchJob) btnRunBatchJob.addEventListener('click', runBatchJob);
        if (showEmptyCachesCheckbox) showEmptyCachesCheckbox.addEventListener('change', renderCacheTable);

        // –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è inline onclick
        window.clearCache = clearCache;

    </script>

</body>

</html>